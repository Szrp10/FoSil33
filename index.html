<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Fosil33 - Private Forum</title>
  <style>
    :root {
      --primary: #075e54;
      --secondary: #25d366;
      --bg-pattern: #e5ddd5;
      --my-gradient: linear-gradient(135deg, #25d366 0%, #075e54 100%);
    }

    body { font-family: 'Segoe UI', sans-serif; background: var(--bg-pattern); margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
    
    #auth-screen { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .auth-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .auth-box input { width: 85%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; outline: none; }
    .auth-box button { width: 95%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }

    #main-app { display: none; flex-direction: column; height: 100%; position: relative; }

    header { background: var(--primary); color: white; padding: 10px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0; z-index: 10; cursor: pointer; }
    header .status-online { font-size: 10px; font-weight: normal; color: #adffad; display: block; }

    #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background-image: radial-gradient(#d1c7bc 1px, transparent 1px); background-size: 20px 20px; scroll-behavior: smooth; }
    
    .msg { max-width: 75%; padding: 8px 12px; border-radius: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.15); display: flex; flex-direction: column; cursor: pointer; }
    .msg.me { align-self: flex-end; background: var(--my-gradient); color: white; border-bottom-right-radius: 2px; }
    .msg.other { align-self: flex-start; background: #ffffff; color: #333; border-bottom-left-radius: 2px; }
    
    .sender { font-size: 11px; font-weight: bold; margin-bottom: 2px; }
    .msg.me .sender { color: #adffad; }
    .msg.other .sender { color: var(--primary); }

    .reply-box-preview { background: rgba(0,0,0,0.05); border-left: 3px solid var(--secondary); padding: 5px 8px; margin-bottom: 6px; border-radius: 4px; display: block; }
    .reply-sender { font-weight: bold; font-size: 10px; display: block; margin-bottom: 2px; }
    .reply-content { font-size: 11px; opacity: 0.8; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .heart { position: absolute; bottom: -8px; right: 8px; font-size: 14px; background: white; border-radius: 12px; padding: 1px 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); color: #333; }
    .time { font-size: 9px; align-self: flex-end; margin-top: 4px; opacity: 0.7; }

    .input-container { background: #fff; display: flex; flex-direction: column; border-top: 1px solid #ddd; padding-bottom: env(safe-area-inset-bottom, 10px); flex-shrink: 0; z-index: 10; }
    #emoji-bar { display: flex; gap: 15px; padding: 8px 15px; background: #f9f9f9; border-bottom: 1px solid #eee; font-size: 18px; overflow-x: auto; }
    #reply-preview { display: none; background: #f0f0f0; padding: 10px 15px; font-size: 13px; border-left: 5px solid var(--secondary); justify-content: space-between; align-items: center; }
    .input-box { display: flex; padding: 10px; align-items: center; gap: 10px; }
    #msgInput { flex: 1; border: 1px solid #ddd; padding: 12px 15px; border-radius: 25px; outline: none; font-size: 16px; }
    button.send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; flex-shrink: 0; }

    #typing { font-size: 11px; color: #555; font-style: italic; padding: 2px 15px; height: 18px; }
    #new-msg-btn { position: absolute; bottom: 120px; right: 20px; background: var(--secondary); color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: none; cursor: pointer; z-index: 100; }

    #admin-modal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      z-index: 2000; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-content {
      background: white; width: 100%; max-width: 400px; border-radius: 20px;
      padding: 20px; max-height: 80vh; overflow-y: auto; box-sizing: border-box;
    }
    .member-row { padding: 12px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 4px; }
    .close-btn { background: var(--primary); color: white; width: 100%; border: none; padding: 12px; border-radius: 10px; font-weight: bold; margin-top: 15px; }
  </style>
</head>
<body>

  <div id="auth-screen">
    <div class="auth-box">
      <h2>Fosil33 ‚òï</h2>
      <input type="text" id="username" placeholder="Username" autocomplete="off">
      <input type="password" id="password" placeholder="Password">
      <button onclick="handleAuth()">MASUK</button>
      <div id="auth-msg" style="color: red; font-size: 11px; margin-top: 10px;"></div>
    </div>
  </div>

  <div id="main-app">
    <header onclick="secretAdminTap()">
      <span>Fosil33 ‚òï</span>
      <span id="online-indicator" class="status-online">üü¢ Mendeteksi...</span>
    </header>

    <div id="chat-container" onscroll="checkScroll()"></div>
    <div id="new-msg-btn" onclick="scrollToBottom()">‚¨áÔ∏è Pesan Baru</div>
    <div id="typing"></div> 
    
    <div class="input-container">
      <div id="reply-preview">
        <div id="reply-text"> Membalas... </div>
        <button onclick="cancelReply()" style="border:none; background:none; color:red; font-weight:bold;">X</button>
      </div>
      <div id="emoji-bar">
        <span onclick="addEmoji('üòÇ')">üòÇ</span><span onclick="addEmoji('üî•')">üî•</span><span onclick="addEmoji('üëç')">üëç</span><span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="addEmoji('‚ú®')">‚ú®</span>
      </div>
      <div class="input-box">
        <input type="text" id="msgInput" placeholder="Ketik pesan..." autocomplete="off">
        <button class="send-btn" onclick="kirim()">‚û§</button>
      </div>
    </div>
  </div>

  <div id="admin-modal">
    <div class="modal-content">
      <h3 style="margin-top:0; color:var(--primary);">üïµÔ∏è Data Anggota (Rahasia)</h3>
      <div id="member-list">Sedang memuat...</div>
      <button class="close-btn" onclick="document.getElementById('admin-modal').style.display='none'">Tutup</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, deleteDoc, updateDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqguYRzX9J417O3xCej1aUzCNz5YIueuU",
      authDomain: "fosil33-e4e5e.firebaseapp.com",
      projectId: "fosil33-e4e5e",
      storageBucket: "fosil33-e4e5e.firebasestorage.app",
      messagingSenderId: "891519748664",
      appId: "1:891519748664:web:c46fcee020e9ed329034cd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "pesan");
    const typingRef = collection(db, "typing");
    const onlineRef = collection(db, "online_users");
    const usersRef = collection(db, "users");

    let namaUser = "";
    let myID = "";
    let selectedReply = null;
    let lastTap = 0;
    let isBottom = true;
    let adminTapCount = 0;
    let firstLoad = true;

    // --- LOGIKA NOTIFIKASI ---
    async function requestNotificationPermission() {
      if ("Notification" in window) {
        if (Notification.permission !== "granted") {
          await Notification.requestPermission();
        }
      }
    }

    function showNotification(sender, text) {
      if (Notification.permission === "granted" && document.hidden) {
        new Notification(`Fosil33: ${sender}`, {
          body: text,
          icon: "https://cdn-icons-png.flaticon.com/512/5968/5968841.png"
        });
      }
    }

    window.handleAuth = async () => {
      const userVal = document.getElementById('username').value.trim().toLowerCase();
      const passVal = document.getElementById('password').value.trim();
      if (!userVal || !passVal) return;
      const userDoc = await getDoc(doc(usersRef, userVal));
      if (userDoc.exists()) {
        if (userDoc.data().pass === passVal) startApp(userVal);
        else document.getElementById('auth-msg').innerText = "Password salah!";
      } else {
        await setDoc(doc(usersRef, userVal), { pass: passVal });
        startApp(userVal);
      }
    };

    function startApp(user) {
      namaUser = user; myID = user;
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'flex';
      requestNotificationPermission(); 
      initChat();
    }

    window.secretAdminTap = async () => {
      if (namaUser !== 'admin') return; 
      adminTapCount++;
      if (adminTapCount >= 5) {
        adminTapCount = 0;
        const modal = document.getElementById('admin-modal');
        const list = document.getElementById('member-list');
        modal.style.display = 'flex';
        list.innerHTML = "Mengambil data...";
        
        const snap = await getDocs(usersRef);
        list.innerHTML = "";
        snap.forEach(d => {
          const row = document.createElement('div');
          row.className = 'member-row';
          row.innerHTML = `<span style="font-weight:bold;">üë§ ${d.id}</span><span style="font-size:12px; color:gray;">Password: ${d.data().pass}</span>`;
          list.appendChild(row);
        });
      }
      setTimeout(() => { adminTapCount = 0; }, 2000);
    };

    window.checkScroll = () => {
      const c = document.getElementById('chat-container');
      isBottom = (c.scrollHeight - c.scrollTop - c.clientHeight) < 100;
      if (isBottom) document.getElementById('new-msg-btn').style.display = 'none';
    };

    window.scrollToBottom = () => {
      const c = document.getElementById('chat-container');
      c.scrollTop = c.scrollHeight;
      document.getElementById('new-msg-btn').style.display = 'none';
    };

    function initChat() {
      const updateOnline = () => setDoc(doc(onlineRef, myID), { nama: namaUser, lastActive: Date.now() });
      updateOnline();
      setInterval(updateOnline, 15000);

      onSnapshot(onlineRef, (snapshot) => {
        const now = Date.now();
        let count = 0;
        snapshot.forEach(d => { if (now - d.data().lastActive < 35000) count++; else deleteDoc(d.ref); });
        document.getElementById('online-indicator').innerText = `üü¢ ${count} Orang Online`;
      });

      onSnapshot(query(colRef, orderBy("time", "asc")), (snapshot) => {
        const container = document.getElementById('chat-container');
        
        // Logika Notifikasi untuk Pesan Baru
        if (!firstLoad) {
          snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
              const d = change.doc.data();
              if (d.user !== namaUser) {
                showNotification(d.user, d.text);
              }
            }
          });
        }
        firstLoad = false;

        container.innerHTML = "";
        snapshot.forEach(sDoc => {
          const d = sDoc.data();
          const isMe = d.user === namaUser;
          const jam = d.time ? new Date(d.time.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
          const div = document.createElement('div');
          div.className = `msg ${isMe ? 'me' : 'other'}`;
          div.onclick = () => handleMsgInteraction(sDoc.id, d.user, d.text, isMe);
          
          let replyHTML = d.replyTo ? `<div class="reply-box-preview"><span class="reply-sender" style="color:${isMe?'#adffad':'var(--primary)'}">${d.replyTo.user}</span><span class="reply-content">${d.replyTo.text}</span></div>` : "";
          
          div.innerHTML = `<span class="sender">${isMe ? 'Kamu' : d.user}</span>${replyHTML}<span style="font-size:14px; line-height:1.4;">${d.text}</span><span class="time">${jam}</span>${d.likes > 0 ? `<div class="heart">‚ù§Ô∏è ${d.likes}</div>` : ""}`;
          container.appendChild(div);
        });
        if (isBottom) scrollToBottom();
        else document.getElementById('new-msg-btn').style.display = 'block';
      });

      const inputPesan = document.getElementById('msgInput');
      inputPesan.addEventListener('input', () => {
        if (inputPesan.value.length > 0) setDoc(doc(typingRef, myID), { nama: namaUser });
        else deleteDoc(doc(typingRef, myID));
      });
      onSnapshot(typingRef, (snapshot) => {
        let users = [];
        snapshot.forEach(doc => { if (doc.id !== myID) users.push(doc.data().nama); });
        document.getElementById('typing').innerText = users.length > 0 ? `${users.join(', ')} ngetik...` : '';
      });
    }

    window.kirim = async () => {
      const input = document.getElementById('msgInput');
      if (!input.value.trim()) return;
      isBottom = true;
      await addDoc(colRef, { user: namaUser, text: input.value, replyTo: selectedReply, likes: 0, time: serverTimestamp() });
      input.value = ""; deleteDoc(doc(typingRef, myID)); cancelReply();
    };

    window.handleMsgInteraction = (id, user, text, isMe) => {
      const now = Date.now();
      if (now - lastTap < 300) updateDoc(doc(db, "pesan", id), { likes: increment(1) });
      else {
        if(isMe || namaUser === 'admin') { if(confirm("Hapus?")) deleteDoc(doc(db, "pesan", id)); }
        else {
          selectedReply = { user, text };
          document.getElementById('reply-preview').style.display = 'flex';
          document.getElementById('reply-text').innerText = `Balas ${user}: ${text.substring(0,15)}...`;
          document.getElementById('msgInput').focus();
        }
      }
      lastTap = now;
    };

    window.cancelReply = () => { selectedReply = null; document.getElementById('reply-preview').style.display = 'none'; };
    window.addEmoji = (e) => { const i = document.getElementById('msgInput'); i.value += e; i.focus(); };
    document.getElementById('msgInput')?.addEventListener("keypress", (e) => { if (e.key === "Enter") kirim(); });
  </script>
</body>
</html>
