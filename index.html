<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fosil33 - Private Forum</title>
  <style>
    :root {
      --primary: #075e54;
      --secondary: #25d366;
      --bg-pattern: #e5ddd5;
      --my-gradient: linear-gradient(135deg, #25d366 0%, #075e54 100%);
    }

    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-pattern); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    
    /* Auth Screen */
    #auth-screen { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .auth-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 100%; max-width: 350px; text-align: center; }
    .auth-box input { width: 85%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; outline: none; }
    .auth-box button { width: 95%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }

    /* Main App */
    #main-app { display: none; flex-direction: column; height: 100vh; }
    header { background: var(--primary); color: white; padding: 12px; text-align: center; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10; }
    header .status-online { font-size: 10px; font-weight: normal; color: #adffad; display: block; }

    #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background-image: radial-gradient(#d1c7bc 1px, transparent 1px); background-size: 20px 20px; }
    
    /* Msg Bubble */
    .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 14.5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; cursor: pointer; }
    .msg.me { align-self: flex-end; background: var(--my-gradient); color: white; border-bottom-right-radius: 4px; }
    .msg.other { align-self: flex-start; background: #ffffff; color: #333; border-bottom-left-radius: 4px; }
    
    /* Fix Reply View */
    .reply-box-preview { background: rgba(0,0,0,0.08); border-left: 4px solid var(--secondary); padding: 8px; margin-bottom: 8px; border-radius: 6px; }
    .reply-sender { font-weight: bold; font-size: 11px; display: block; color: var(--primary); margin-bottom: 2px; }
    .reply-content { font-size: 12px; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
    .msg.me .reply-sender { color: #dcf8c6; }

    .heart { position: absolute; bottom: -10px; right: 10px; font-size: 16px; background: white; border-radius: 50%; padding: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .input-container { background: #fff; display: flex; flex-direction: column; border-top: 1px solid #ddd; }
    #emoji-bar { display: flex; gap: 15px; padding: 8px 15px; background: #f9f9f9; border-bottom: 1px solid #eee; font-size: 18px; overflow-x: auto; }
    #reply-preview { display: none; background: #f0f0f0; padding: 10px 15px; font-size: 13px; border-left: 5px solid var(--secondary); justify-content: space-between; align-items: center; }
    .input-box { display: flex; padding: 12px; align-items: center; gap: 10px; }
    #msgInput { flex: 1; border: 1px solid #ddd; padding: 12px 18px; border-radius: 25px; outline: none; }
    button.send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; }

    .sender { font-size: 11px; font-weight: bold; margin-bottom: 3px; }
    .time { font-size: 9px; color: rgba(0,0,0,0.4); align-self: flex-end; margin-top: 5px; }
    .msg.me .time { color: rgba(255,255,255,0.7); }
    #typing { font-size: 12px; color: #555; font-style: italic; padding: 5px 15px; height: 20px; }
  </style>
</head>
<body>

  <div id="auth-screen">
    <div class="auth-box">
      <h2 style="margin:0;">Fosil33 ‚òï</h2>
      <p style="font-size: 12px; color: #666; margin-bottom:20px;">Private Forum Log-in</p>
      <input type="text" id="username" placeholder="Username" autocomplete="off">
      <input type="password" id="password" placeholder="Password">
      <button onclick="handleAuth()">GAS MASUK</button>
      <div id="auth-msg" style="color: red; font-size: 11px; margin-top: 10px;"></div>
    </div>
  </div>

  <div id="main-app">
    <header>
      <span>Fosil33 ‚òï</span>
      <span id="online-indicator" class="status-online">üü¢ Mendeteksi...</span>
    </header>
    <div id="chat-container"></div>
    <div id="typing"></div> 
    <div class="input-container">
      <div id="reply-preview">
        <div id="reply-text"> Membalas... </div>
        <button onclick="cancelReply()" style="border:none; background:none; color:red; font-weight:bold;">X</button>
      </div>
      <div id="emoji-bar">
        <span onclick="addEmoji('üòÇ')">üòÇ</span><span onclick="addEmoji('üî•')">üî•</span><span onclick="addEmoji('üôå')">üôå</span>
        <span onclick="addEmoji('üëç')">üëç</span><span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="addEmoji('‚ú®')">‚ú®</span>
      </div>
      <div class="input-box">
        <input type="text" id="msgInput" placeholder="Ketik pesan..." autocomplete="off">
        <button class="send-btn" onclick="kirim()">‚û§</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqguYRzX9J417O3xCej1aUzCNz5YIueuU",
      authDomain: "fosil33-e4e5e.firebaseapp.com",
      projectId: "fosil33-e4e5e",
      storageBucket: "fosil33-e4e5e.firebasestorage.app",
      messagingSenderId: "891519748664",
      appId: "1:891519748664:web:c46fcee020e9ed329034cd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "pesan");
    const typingRef = collection(db, "typing");
    const onlineRef = collection(db, "online_users");
    const usersRef = collection(db, "users");

    let namaUser = "";
    let myID = "";
    let selectedReply = null;
    let lastTap = 0;

    window.handleAuth = async () => {
      const userVal = document.getElementById('username').value.trim().toLowerCase();
      const passVal = document.getElementById('password').value.trim();
      if (!userVal || !passVal) return;
      const userDoc = await getDoc(doc(usersRef, userVal));
      if (userDoc.exists()) {
        if (userDoc.data().pass === passVal) startApp(userVal);
        else document.getElementById('auth-msg').innerText = "Password salah!";
      } else {
        await setDoc(doc(usersRef, userVal), { pass: passVal });
        startApp(userVal);
      }
    };

    function startApp(user) {
      namaUser = user; myID = user;
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'flex';
      initChat();
    }

    function initChat() {
      // Logic Online (Fixing Online Count)
      const userOnlineDoc = doc(onlineRef, myID);
      setDoc(userOnlineDoc, { nama: namaUser, lastActive: Date.now() });
      
      // Update heartbeat supaya status online tetap akurat
      setInterval(() => { setDoc(userOnlineDoc, { nama: namaUser, lastActive: Date.now() }); }, 20000);

      onSnapshot(onlineRef, (snapshot) => {
        const now = Date.now();
        let count = 0;
        snapshot.forEach(doc => {
          if (now - doc.data().lastActive < 40000) count++; // Anggap offline jika > 40 detik
          else deleteDoc(doc.ref); // Bersihkan sampah database
        });
        document.getElementById('online-indicator').innerText = `üü¢ ${count} Orang Online`;
      });

      // Tampilkan Pesan
      onSnapshot(query(colRef, orderBy("time", "asc")), (snapshot) => {
        const container = document.getElementById('chat-container');
        container.innerHTML = "";
        snapshot.forEach(sDoc => {
          const d = sDoc.data();
          const isMe = d.user === namaUser;
          const jam = d.time ? new Date(d.time.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
          const div = document.createElement('div');
          div.className = `msg ${isMe ? 'me' : 'other'}`;
          div.onclick = () => handleMsgInteraction(sDoc.id, d.user, d.text, isMe);
          
          let replyHTML = d.replyTo ? `
            <div class="reply-box-preview">
              <span class="reply-sender">${d.replyTo.user}</span>
              <span class="reply-content">${d.replyTo.text}</span>
            </div>` : "";
          
          div.innerHTML = `<span class="sender" style="color:${isMe ? '#dcf8c6' : '#075e54'}">${isMe ? 'Kamu' : d.user}</span>${replyHTML}<span>${d.text}</span><span class="time">${jam}</span>${d.likes > 0 ? `<div class="heart">‚ù§Ô∏è ${d.likes}</div>` : ""}`;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      });

      // Typing Logic
      const inputPesan = document.getElementById('msgInput');
      inputPesan.addEventListener('input', () => {
        if (inputPesan.value.length > 0) setDoc(doc(typingRef, myID), { nama: namaUser });
        else deleteDoc(doc(typingRef, myID));
      });
      onSnapshot(typingRef, (snapshot) => {
        let users = [];
        snapshot.forEach(doc => { if (doc.id !== myID) users.push(doc.data().nama); });
        document.getElementById('typing').innerText = users.length > 0 ? `${users.join(', ')} ngetik...` : '';
      });
    }

    window.kirim = async () => {
      const input = document.getElementById('msgInput');
      if (!input.value.trim()) return;
      await addDoc(colRef, { user: namaUser, text: input.value, replyTo: selectedReply, likes: 0, time: serverTimestamp() });
      input.value = ""; deleteDoc(doc(typingRef, myID)); cancelReply();
    };

    window.handleMsgInteraction = (id, user, text, isMe) => {
      const now = Date.now();
      if (now - lastTap < 300) updateDoc(doc(db, "pesan", id), { likes: increment(1) });
      else {
        if(isMe) { if(confirm("Hapus?")) deleteDoc(doc(db, "pesan", id)); }
        else {
          selectedReply = { user, text };
          document.getElementById('reply-preview').style.display = 'flex';
          document.getElementById('reply-text').innerText = `Balas ${user}: ${text.substring(0,15)}...`;
          document.getElementById('msgInput').focus();
        }
      }
      lastTap = now;
    };

    window.cancelReply = () => { selectedReply = null; document.getElementById('reply-preview').style.display = 'none'; };
    window.addEmoji = (e) => { const i = document.getElementById('msgInput'); i.value += e; i.focus(); };
    document.getElementById('msgInput')?.addEventListener("keypress", (e) => { if (e.key === "Enter") kirim(); });
  </script>
</body>
    </html>
