<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fosil33 - Reply System</title>
  <style>
    :root {
      --bg-color: #e5ddd5;
      --primary: #075e54;
      --secondary: #25d366;
      --my-bubble: #dcf8c6;
    }

    body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); margin: 0; display: flex; flex-direction: column; height: 100vh; }
    header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
    
    /* Bubble Chat */
    .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; position: relative; font-size: 14px; animation: pop 0.2s ease; box-shadow: 0 1px 1px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
    .msg.me { align-self: flex-end; background: var(--my-bubble); border-bottom-right-radius: 2px; }
    .msg.other { align-self: flex-start; background: #ffffff; border-bottom-left-radius: 2px; }
    
    /* Style Balasan */
    .reply-box-preview { background: rgba(0,0,0,0.05); border-left: 4px solid var(--primary); padding: 5px; margin-bottom: 5px; border-radius: 4px; font-size: 12px; }
    .reply-sender { font-weight: bold; font-size: 10px; display: block; }

    /* Input Area & Preview Reply */
    .input-container { background: #f0f0f0; display: flex; flex-direction: column; border-top: 1px solid #ddd; }
    #reply-preview { display: none; background: #e2e2e2; padding: 8px 15px; font-size: 12px; border-left: 5px solid var(--secondary); justify-content: space-between; align-items: center; }
    .input-box { display: flex; padding: 10px; align-items: center; gap: 10px; }
    input { flex: 1; border: none; padding: 12px; border-radius: 25px; outline: none; font-size: 16px; }
    button { background: var(--secondary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; }

    .sender { font-size: 11px; font-weight: bold; margin-bottom: 2px; }
    .time { font-size: 9px; color: #888; align-self: flex-end; margin-top: 4px; }
    #typing { font-size: 11px; color: #555; font-style: italic; padding: 2px 15px; height: 18px; }
  </style>
</head>
<body>

  <header>Fosil33 ☕</header>

  <div id="chat-container"></div>
  <div id="typing"></div> 

  <div class="input-container">
    <div id="reply-preview">
      <div id="reply-text"> Membalas pesan... </div>
      <button onclick="cancelReply()" style="width:20px; height:20px; background:red; font-size:10px;">X</button>
    </div>
    <div class="input-box">
      <input type="text" id="msgInput" placeholder="Ketik pesan..." autocomplete="off">
      <button onclick="kirim()">➤</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqguYRzX9J417O3xCej1aUzCNz5YIueuU",
      authDomain: "fosil33-e4e5e.firebaseapp.com",
      projectId: "fosil33-e4e5e",
      storageBucket: "fosil33-e4e5e.firebasestorage.app",
      messagingSenderId: "891519748664",
      appId: "1:891519748664:web:c46fcee020e9ed329034cd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "pesan");
    const typingRef = collection(db, "typing");

    const namaUser = prompt("Masukkan nama kamu:") || "Anonim";
    const myID = Math.random().toString(36).substring(7);
    let selectedReply = null; // Menyimpan data pesan yang akan dibalas

    const stringToColor = (str) => {
      let hash = 0;
      for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
      return `hsl(${hash % 360}, 70%, 30%)`;
    };

    // Fungsi klik pesan
    window.handleMsgClick = (id, user, text, isMe) => {
      if(isMe) {
        if(confirm("Hapus pesan kamu?")) deleteDoc(doc(db, "pesan", id));
      } else {
        selectedReply = { user, text };
        document.getElementById('reply-preview').style.display = 'flex';
        document.getElementById('reply-text').innerText = `Membalas ${user}: "${text.substring(0, 20)}..."`;
        document.getElementById('msgInput').focus();
      }
    };

    window.cancelReply = () => {
      selectedReply = null;
      document.getElementById('reply-preview').style.display = 'none';
    };

    // --- TYPING ---
    const inputPesan = document.getElementById('msgInput');
    inputPesan.addEventListener('input', () => {
      if (inputPesan.value.length > 0) setDoc(doc(typingRef, myID), { nama: namaUser });
      else deleteDoc(doc(typingRef, myID));
    });

    onSnapshot(typingRef, (snapshot) => {
      const typingDiv = document.getElementById('typing');
      let usersTyping = [];
      snapshot.forEach(doc => { if (doc.id !== myID) usersTyping.push(doc.data().nama); });
      typingDiv.innerText = usersTyping.length > 0 ? `${usersTyping.join(', ')} sedang mengetik...` : '';
    });

    // --- KIRIM ---
    window.kirim = async () => {
      const text = inputPesan.value.trim();
      if (text !== "") {
        inputPesan.value = "";
        deleteDoc(doc(typingRef, myID));
        
        await addDoc(colRef, {
          user: namaUser,
          userId: myID,
          text: text,
          replyTo: selectedReply, // Masukkan data reply jika ada
          time: serverTimestamp()
        });
        
        cancelReply();
      }
    };

    inputPesan.addEventListener("keypress", (e) => { if (e.key === "Enter") kirim(); });

    // --- TAMPILKAN ---
    onSnapshot(query(colRef, orderBy("time", "asc")), (snapshot) => {
      const container = document.getElementById('chat-container');
      container.innerHTML = "";
      snapshot.forEach(sDoc => {
        const d = sDoc.data();
        const isMe = d.userId === myID;
        const jam = d.time ? new Date(d.time.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
        
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'me' : 'other'}`;
        div.onclick = () => handleMsgClick(sDoc.id, d.user, d.text, isMe);

        let replyHTML = "";
        if(d.replyTo) {
          replyHTML = `<div class="reply-box-preview">
            <span class="reply-sender">${d.replyTo.user}</span>
            ${d.replyTo.text.substring(0, 30)}...
          </div>`;
        }

        div.innerHTML = `
          <span class="sender" style="color: ${stringToColor(d.user)}">${isMe ? 'Kamu' : d.user}</span>
          ${replyHTML}
          <span>${d.text}</span>
          <span class="time">${jam}</span>
        `;
        container.appendChild(div);
      });
      container.scrollTop = container.scrollHeight;
    });
  </script>
</body>
</html>
